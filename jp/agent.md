# Agent Guide — PoliTopics
[English Version](../agent.md)

PoliTopics は、日本の国会会議録を検索可能な要約と公開Web体験に変換する3部構成のパイプラインです。

このリポジトリは、人間と AI エージェント (例: Codex, Gemini) が共同で開発するように設計されています。すべてのエージェントは、このドキュメントで定義されているルールに厳密に従う必要があります。

---

## リポジトリ構造

| ディレクトリ                   | コンポーネント                       | 概要                                                                               |
| --------------------------- | ------------------------------- | ------------------------------------------------------------------------------------- |
| `PoliTopicsDataCollection/` | 収集 + プロンプトファンアウト      | 会議録のダウンロード、プロンプトのチャンク化、ペイロードのS3への保存、DynamoDBへのタスク登録 |
| `PoliTopicsRecap/`          | LLM要約 + 記事永続化 | タスクの処理、要約の生成、DynamoDB + S3への記事保存                |
| `PoliTopicsWeb/`            | Webアプリ + API                   | DynamoDBとS3をバックエンドとするNext.js SPA + Fastify API                                   |

インフラストラクチャのプロビジョニングは **Terraform のみ** で管理されます。このリポジトリ内でのアプリケーションコードによるプロビジョニングは禁止です。

## LocalStack エンドポイント (必須)

ローカルおよび開発環境では、すべての AWS サービスアクセスは以下の LocalStack エンドポイントを使用する必要があります:

- **LocalStack URL:** `http://localstack:4566`

ルール:

- アプリケーションコードに実際の AWS エンドポイントをハードコードしないでください。
- LocalStack エンドポイントは、散在するリテラルではなく、一元化された設定 (例: `config.ts`) を介して参照する必要があります。
- テストおよびローカル実行では、デフォルトの AWS エンドポイントとして `localstack:4566` を想定する必要があります。
- エンドポイントが異なる必要がある場合は、コードロジックではなく設定でオーバーライドする必要があります。

---

## 厳格な要件 (必須)

### 1. 機能の追加または変更時は常にテストを実行する

- 機能の追加、動作の変更、またはリファクタリングは、**テストスイートを実行する必要があります**。
- テストは **Jest** を使用して記述されています。
- 適切な場合、変更をカバーするためのテストを追加または更新します。

---

### 2. インフラストラクチャのプロビジョニングは Terraform のみに限定する

- Terraform のみを許可します。
- CDK、CloudFormation、または AWS SDK を使ったアプリケーションコードでのリソース作成は禁止です。
- インフラ変更は `terraform/` 配下と IaC ドキュメントに限定します。

---

### 3. local/dev での AWS サービスアクセスに LocalStack を使用する

- AWS サービス (S3, DynamoDB, SQS, SNS, EventBridge など) へのアクセスは、以下を行う必要があります:
  - ローカルおよび開発ワークフローには **LocalStack** を使用する
  - 実際の AWS アカウントへの直接アクセスを想定しない
- LocalStack エンドポイント、リージョン、および認証情報は設定可能である必要があります。

---

### 4. 設定を一元化し、環境変数を最小限にする

- 環境変数は、特に以下の外部では **最小限** にする必要があります:
  - `local`
  - `stage`
  - `prod`
- 設定は `config.ts` などの単一のモジュールに一元化する必要があります。
- アプリケーションコードは、散在する `process.env` 値を直接読み取っては **いけません**。
- 以下を優先してください:
  - 基本デフォルト
  - 環境固有のオーバーライド

---

### 5. 明示的なビルド時環境選択を要求する

- ビルドは以下のいずれかを明示的にターゲットにする必要があります:
  - `local`
  - `stage`
  - `prod`
- 環境選択はランタイムでの暗黙的ではなく、**ビルド時に** 行われる必要があります。
- パターン例:
  - `build:local`
  - `build:stage`
  - `build:prod`

---

### 6. エラーメッセージはデバッグコンテキストとともに記録する必要がある

- すべてのエラーは **stdout / stderr または構造化ログ** に書き込む必要があります。
- エラー出力には、可能な場合、以下を含める必要があります:
  - 何が失敗したか
  - どこで失敗したか
  - 関連する識別子 (タスク ID、記事 ID、リクエスト ID など)
- ログは一般的なメッセージではなく、**実用的なデバッグのヒント** を提供する必要があります。

---

### 7. スキーマまたは仕様の変更は文書化する必要がある

- 以下への変更:
  - データスキーマ
  - API コントラクト
  - タスクフォーマット
  - プロンプト構造
- 適切な **`docs/` ドキュメント** に反映する必要があります。
- コードとドキュメントは同期している必要があります。

---

### 8. サブモジュールごとの変更を `changes.agent.md` に記録する

- **変更された各サブモジュール** について、以下に変更を記録します:
  - `PoliTopicsDataCollection/changes.agent.md`
  - `PoliTopicsRecap/changes.agent.md`
  - `PoliTopicsWeb/changes.agent.md`
- ファイルが存在しない場合は、**作成してください**。

各エントリには以下を含める必要があります:

- エージェント名
- 日時 (**JST – 日本標準時**)
- キーワード
- トピック
- 詳細な説明

### 9. 各変更エントリに変更されたファイルをリストする (必須)

`changes.agent.md` 内の各変更エントリは、そのエントリの一部として変更されたすべてのファイルを明示的にリストする必要があります。

ルール:

- ファイルリストは **リポジトリルートからの相対パス** を使用する必要があります。
- 関連するすべてのファイルを含めてください:
  - ソースコード
  - テストファイル
  - 設定ファイル
  - ドキュメント
- 生成されたファイルを含めないでください。
- 検討されたが変更されなかったファイルを含めないでください。

---

## エージェントがシェルコマンドを実行できない場合 (必須)

エージェント環境がシェルコマンドの実行を許可しない場合 (例: `npm`, `pnpm`, `jest`, `docker` などを実行できない)、
エージェントはコマンドが実行されたと主張しては **いけません**。

代わりに、エージェントは以下を行う必要があります:

1. 現在の環境ではシェルコマンドを実行できないことを明確に述べます。
2. 所有者がローカル/CI で実行すべき正確なコマンドを提供します。
3. エージェントが障害を診断できるように、所有者が貼り付けるべきログ/出力を指定します。

### 所有者に実行を依頼するもの

最低限、以下を要求してください:

- インストール/ビルドコマンド (関連する場合)
- Jest テストコマンド
- リント/型チェックコマンド (リポジトリに存在する場合)
- LocalStack 起動/ヘルスチェック (AWS インタラクションが関与する場合)

### 要求する必須ログ/出力

所有者に以下を貼り付けるよう依頼してください:

- 完全なコマンド出力 (stdout + stderr)、最後の数行だけでなく
- 実行された正確なコマンド
- Node.js バージョンとパッケージマネージャバージョン (JS/TS の場合):
  - `node -v`
  - `npm -v` または `pnpm -v` または `yarn -v`
- ビルド時に使用された関連する環境選択 (local/stage/prod)
- LocalStack が関与する場合:
  - 障害発生時刻前後の LocalStack ログ
  - 使用されているサービスエンドポイント
  - ログに表示されているリクエスト ID / タスク ID / 記事 ID

### エージェントが出力すべき標準プロンプト

ブロックされた場合、エージェントは次のような「これを実行して結果を貼り付けてください」セクションを出力する必要があります:

#### これをローカルで実行してください

- `<command 1>`
- `<command 2>`
- ...

#### 結果を貼り付けてください

- 各コマンドの完全な stdout/stderr
- バージョン: `node -v`, `<pkg-manager> -v`
- ビルドターゲット環境 (local/stage/prod)
- ログに表示されている ID (taskId/articleId/requestId)
- LocalStack ログ (該当する場合)

---

## 変更ログ更新ルール (重要)

### エントリのライフサイクル

- 単一のエントリは **1つの首尾一貫したトピックまたは作業単位** を表します。
- トピックが大幅に変更された場合は、**新しいエントリを開始してください**。

### レビュー後の変更

- **リポジトリ所有者との議論またはレビューの後** に行われた軽微な変更
  (例: 文言の修正、小さなリファクタリング、設定の調整、ログの改善)
  は、以下のタイトルのセクションの下に追加する必要があります:

  `### Changes After Review`

- 同じトピックに属する場合、レビュー後の小さな調整のために新しいエントリを作成 **しないでください**。

### 新しいエントリを作成するタイミング

以下の場合に新しいエントリを作成してください:

- 変更の目的が異なる場合
- 影響を受ける責任または動作が変更される場合
- 新機能、スキーマ、またはワークフローが導入される場合
- 所有者との議論のトピックが明らかに移行した場合

### 原則

- 1トピック = 1エントリ
- フィードバック後の改善 = `Changes After Review`

---

## 推奨プラクティス (推奨)

- 変更を小さく、レビュー可能に保つ
- 暗黙の仮定よりも明示的な動作を優先する
- 設定変更を追跡しやすくする
- LocalStack 固有のロジックを分離し、設定可能にする
- 早く失敗させるが、明確かつ有益にログを記録する

---

## 変更ワークフローチェックリスト

### 実装前

- 影響を受けるサブモジュールを特定する
- スキーマ、API、または仕様が変更されるかどうかを確認する
- 必要な設定変更を特定する

### 実装中

- 新しい設定を `config.ts` に一元化する
- AWS インタラクションに LocalStack を使用する
- 十分なコンテキストを持つ意味のあるエラーをログに記録する
- インフラ変更は Terraform に限定し、アプリケーションコードでのプロビジョニングを避ける

### 実装後

- Jest テストを実行する
- スキーマ/仕様が変更された場合は `docs/` を更新する
- 影響を受ける各 `changes.agent.md` にエントリを追加する
- 明示的な環境選択でビルドが機能することを確認する

---

## プルリクエスト / 変更サマリーの期待事項

以下を含めてください:

- ユーザー向けの変更サマリー
- Jest テストコマンドと結果
- LocalStack 関連のノート (サービス, エンドポイント)
- 設定変更 (新しいキー, 環境の差異)
- ドキュメントの更新 (該当する場合)
- 追加された `changes.agent.md` エントリ
