# 機能ガイド
[English Version](../../docs/features.md)

このドキュメントでは、PoliTopics システムの主要な機能と機能フローを機能ごとに整理して説明します。

## 1. データ取り込みとタスク管理 (DataCollection)
**DataCollection** サービスは、新しいコンテンツを発見し、処理の準備をする責任があります。

- **国会 API 統合**: 日付範囲に基づいて会議録を取得します。
- **スマートチャンキング**: 長い会議の議事録を、LLM のコンテキストウィンドウ（トークン予算を考慮）に収まる管理可能なチャンクに分割します。
- **タスク作成**:
  - 各会議 (Issue ID) に対して DynamoDB にマスタタスクを作成します。
  - プロンプトペイロードを S3 に保存します。
  - 「シングルチャンク」（短い会議）と「Map-Reduce」（長い会議）の両方の戦略をサポートします。

## 2. AI 要約パイプライン (Recap)
**Recap** サービスはタスクを消費し、実際のコンテンツを生成します。

- **ポーリングと処理**: DynamoDB を継続的にチェックして保留中のタスクを探します。
- **スケジューラ**: API レート制限と予算制約を尊重するための設定可能な実行ウィンドウ (例: 9:00-17:00)。
- **LLM 統合**: Google Gemini Pro を使用して要約を生成します。
  - **Map フェーズ**: 長い会議の個々のチャンクを要約します。
  - **Reduce フェーズ**: チャンク要約を最終的な一貫した記事に結合します。
- **リトライメカニズム**: 指数バックオフを使用して失敗したタスクを自動的にリトライします。
- **障害分析**: デバッグのために無効なペイロード (例: LLM からの不正な JSON) を S3 にダンプします。

## 3. Web と API 体験 (Web)
**Web** コンポーネントは、エンドユーザーにコンテンツを提供します。

- **検索と発見**:
  - キーワード、カテゴリ、発言者による高速なクライアントサイドフィルタリング。
  - 効率的な初期ロードのためのバックエンド "Headlines" API。
  - **シンインデックス**: 重いコンテンツをロードせずに高性能なリストクエリを行うために、DynamoDB は特殊なインデックスアイテム (GSI) を使用します。
- **リッチコンテンツレンダリング**:
  - **Markdown サポート**: 要約は GFM (GitHub Flavored Markdown) を使用してレンダリングされ、リストやリンクをサポートします。
  - **セキュアアセット**: 重いコンテンツ (完全な要約、対話ログ) は S3 に保存され、バックエンドによってオンザフライで生成される短い有効期限を持つ **署名付き URL** を介して配信されます。
- **開発者ツール**:
  - **Swagger UI**: `/docs` (local/dev のみ) で利用可能なインタラクティブな API ドキュメント。
  - **レイテンシロギング**: パフォーマンス監視のためにバックエンドが高解像度のタイミングをログに記録します。

## 4. ホスティングとインフラストラクチャ
システムは、モダンで費用対効果の高いインフラストラクチャ戦略を使用しています。

- **フロントエンドホスティング**:
  - **Production/Stage**: 低レイテンシのグローバル配信のために **Cloudflare R2** でホストされます。
  - **Local/Dev**: クラウドコストなしで本番環境をシミュレートするために **LocalStack S3** でホストされます。
- **サーバーレスバックエンド**: すべてのロジックは AWS Lambda (または LocalStack 相当) 上で実行されます。
- **Infrastructure as Code**: スタック全体が Terraform で定義されており、ローカル、ステージ、本番で同一の環境を実現します。

## 5. モニタリングと通知
一元化された通知システムにより、オペレーターは Discord を介して情報を得ることができます。

- **チャンネルルーティング**:
  - `#error`: 重大な障害 (例: 予算超過、未処理の例外)。
  - `#warn`: 重大でない問題 (例: リトライ、不正な LLM レスポンス)。
  - `#batch`: ジョブ完了レポート (例: "50件の会議を処理しました")。
  - `#access`: Web バックエンドからのリアルタイムアクセスログ (ステータス 4xx/5xx)。
